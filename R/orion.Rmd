---
title: "orion_paper"
output: html_document
date: "2023-08-18"
---

```{r setup, include=FALSE}
library(data.table)
library(tidyr)  # For gather()
library(tidyverse)
library(ggplot2)
library(survival)
library(forestplot)
library(survminer)
source("~/git/cysift/R/helpers.R")
source("~/Sorger/projects/orion/R/orion_helpers.R")
```

```{r load-data, include=FALSE}
# load clinical data
load_redcap()

# re-format pMMR into factor
redcap$pMMR <- factor(redcap$pMMR, levels = c(0, 1), labels = c("dMMR", "pMMR"))

# Verify the transformation
table(redcap$pMMR)

## DUMMY data for the unknown grade data
redcap[Grade == "Unknown", Grade := "Low"]
redcap$Grade <- factor(redcap$Grade, levels = c("Low", "High"))

# setup other clinical/histological adta
redcap[, mucinous := as.factor(ifelse(grepl("ucinous", Histology), 1, 0))]
redcap$Location <- factor(redcap$Location, levels = c("Appendix", "Cecum", "Ascending", "Transverse", "Descending", "Sigmoid", "Rectosigmoid", "Rectum"))

# anatomic location
redcap[, side := {
  if (Location %in% c("Appendix","Cecum","Ascending","Transverse")) {
    "Right"
  } else if (Location %in% c("Sigmoid","Descending")) {
    "Left"
  } else {
    "Rectal"
  }
}, by="Slide_ID"]
```

```{r plot-setup-stuff, include=FALSE}
# ggplot theme
theme_jw <- function() {
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text = element_text(color = "black")
  )
}

# color theme
pMMR_colors <- c("dMMR" = "#fdc086", "pMMR" = "#5ab4ac", "tipMMR"="#beaed4")

# plot to pdf function
save_pdf <- function(g, filename, width=10, height=10) {
  filepath <- paste0("~/Sorger/projects/orion/figs_raw_paper/", filename)
  
  pdf(filepath, useDingbats = FALSE, width, height)
  print(g)
  dev.off()
}
```

```{r cys-read, include=FALSE}
#dtr <- readRDS("~/Sorger/cache/chain.rds")

if (TRUE) {
  files <- list.files(path = "~/Sorger/projects/orion/orion_1_74/margin/", full.names = TRUE)
  files <- files[grepl("cys$", files)]
  
  #num_cells <- sum(sapply(files, function(f) {
  #  fread(cmd=paste("cysift count", f))$V1
  #}))
  
  header <- header_read(files[1])
  # read all the data as the means within the tumor compartment
  dtt <- lapply(files, function(f) {
    cat(basename(f), "\n")
    dt <- fread(cmd=paste("cysift filter -T -A 5",f,"/tmp/tmp.cys && cysift mean /tmp/tmp.cys - | cysift view -"))
    setnames(dt, paste0("V",seq(6)), c("sample","cell","x","y","pflag","cflag"))
    setnames(dt, paste0("V",seq(7,ncol(dt))), header$id[header$tag_type %in% c("CA","MA")])
    dt[, Slide_ID := sub("^(LSP[0-9]+).*", "\\1", basename(f))]
    dt[, margin := "margin5"]
    return(dt)
  })
  dtr <- rbindlist(dtt)
  saveRDS(dtr, "~/Sorger/cache/margin5.rds", compress=FALSE)
  
  
}


```
```{r merge-clinical-imaging, include=FALSE}

rr <- merge(data.table::copy(redcap), dtr, by = "Slide_ID", all.x = TRUE)
```

```{r mark-the-tipMMR, include=FALSE}
if (FALSE) {
  hard_coded_tip <- c("LSP14418", "LSP14398", "LSP14423", "LSP14438", "LSP14393", "LSP14403", "LSP14458", "LSP10771", "LSP14388", "LSP14468", "LSP14483", "LSP10388", "LSP14448")
  rr[, tipMMR := factor(ifelse(Slide_ID %in% hard_coded_tip, ifelse(pMMR=="dMMR","dMMR","tipMMR"), as.character(pMMR)))]
} else if (TRUE) {
  
  #### MARK THE TIPMMR BY CD3
  # Slide LSP10716 is the 8/9 ranked by CD3
  rr[, tipMMR := factor(ifelse(CD3_200r > rr[Slide_ID=="LSP10716", CD3_200r], ifelse(pMMR == "dMMR", "dMMR", "tipMMR"), as.character(pMMR)))]
  rr$tipMMR <- factor(rr$tipMMR, levels = c("pMMR", "tipMMR", "dMMR"))
  g <- km_plot(rr[pMMR=="pMMR"], parm="tipMMR", parm.name="tipMMR",parm.labels=c(tipMMR="tipMMR",pMMR="pMMR"), flip=TRUE, flip.labels=TRUE, pfs=TRUE)
  table(rr$tipMMR)
  rr[tipMMR=="tipMMR", Slide_ID]
} else {
  
  #### MARK THE TIPMMR BY CD8
  # Slide LSP10716 is the 23rd percetile of dMMR
  if (FALSE) {
    rr[, tipMMR := factor(ifelse(CD8_200r > rr[Slide_ID=="LSP10716", CD8_200r], ifelse(pMMR == "dMMR", "dMMR", "tipMMR"), as.character(pMMR)))]
    g <- km_plot(rr[pMMR=="pMMR"], parm="tipMMR", parm.name="tipMMR",parm.labels=c(tipMMR="tipMMR",pMMR="pMMR"), flip=TRUE, flip.labels=TRUE, pfs=TRUE)
    table(rr$tipMMR)
    rr[tipMMR=="tipMMR", Slide_ID]
  }
}



```

```{r random-hr-tip}

## get distribution of HR for "random" tipMMR, selected from pMMR
set.seed(42)
rrpmmr <- rr[pMMR == "pMMR"]
hrdist <- sapply(seq(5000), function(cc) {
  if (cc %% 100 == 0)
    cat(cc,"\n")
  rrpmmr[, rand_label := "hi"]
  rrpmmr[sample(.N, 13), rand_label := "low"]
  hr <- as.numeric(km_plot(rrpmmr, parm="rand_label", parm.name="tipMMR",parm.labels=c(tipMMR="tipMMR",pMMR="pMMR"), flip=TRUE, flip.labels=TRUE, pfs=TRUE, return.model=TRUE)$hr[1])
  return(hr)
})
saveRDS(hrdist, "~/Sorger/cache/hrdist.rds")

g <- ggplot(data.table(hr=hrdist[hrdist < 10]), aes(x=hr)) + geom_histogram(stat="bin", binwidth=0.05) + 
  theme_jw() + xlab("Hazard Ratio") + ylab("Frequency") + geom_vline(aes(xintercept=1), color="red") +
 geom_vline(aes(xintercept=0.09), color="blue")
save_pdf(g, "cd3_tipmmr_random.pdf", width=3, height=2)

## iteratively search for best HR
hrs.cd3 <- rbindlist(lapply(sort(rr$CD3_200r)[seq(5,nrow(rr)-5)], function(cc) {
  rr[, tipMMR := factor(ifelse(CD3_200r > cc, ifelse(pMMR == "dMMR", "dMMR", "tipMMR"), as.character(pMMR)))]
  cat(cc, "\n")
  return(data.table(cutoff=cc, hr=as.numeric(km_plot(rr[pMMR=="pMMR"&PFSDays > 0], parm="tipMMR", parm.name="tipMMR",parm.labels=c(tipMMR="tipMMR",pMMR="pMMR"), flip=TRUE, flip.labels=TRUE, pfs=TRUE, return.model=TRUE)$hr[1]), numtip = table(rr$tipMMR)["tipMMR"], cell="CD3"))
}))
hrs.cd8 <- rbindlist(lapply(sort(rr$CD8_200r)[seq(5,nrow(rr)-5)], function(cc) {
  rr[, tipMMR := factor(ifelse(CD8_200r > cc, ifelse(pMMR == "dMMR", "dMMR", "tipMMR"), as.character(pMMR)))]
  return(data.table(cutoff=cc, hr=as.numeric(km_plot(rr[pMMR=="pMMR"&PFSDays > 0], parm="tipMMR", parm.name="tipMMR",parm.labels=c(tipMMR="tipMMR",pMMR="pMMR"), flip=TRUE, flip.labels=TRUE, pfs=TRUE, return.model=TRUE)$hr[1]), numtip = table(rr$tipMMR)["tipMMR"], cell="CD8"))
}))
hrs.cd8 <- rbindlist(lapply(sort(rr$CD8_200r)[seq(5,nrow(rr)-5)], function(cc) {
  rr[, tipMMR := factor(ifelse(CD8_200r > cc, ifelse(pMMR == "dMMR", "dMMR", "tipMMR"), as.character(pMMR)))]
  return(data.table(cutoff=cc, hr=as.numeric(km_plot(rr[pMMR=="pMMR"&PFSDays > 0], parm="tipMMR", parm.name="tipMMR",parm.labels=c(tipMMR="tipMMR",pMMR="pMMR"), flip=TRUE, flip.labels=TRUE, pfs=TRUE, return.model=TRUE)$hr[1]), numtip = table(rr$tipMMR)["tipMMR"], cell="CD8"))
}))
hrs.rand <- rbindlist(lapply(sort(rr$rand)[seq(5,nrow(rr)-5)], function(cc) {
  rr[, tipMMR := factor(ifelse(rand > cc, ifelse(pMMR == "dMMR", "dMMR", "tipMMR"), as.character(pMMR)))]
  return(data.table(cutoff=cc, hr=as.numeric(km_plot(rr[pMMR=="pMMR"&PFSDays > 0], parm="tipMMR", parm.name="tipMMR",parm.labels=c(tipMMR="tipMMR",pMMR="pMMR"), flip=TRUE, flip.labels=TRUE, pfs=TRUE, return.model=TRUE)$hr[1]), numtip = table(rr$tipMMR)["tipMMR"], cell="rand"))
}))
hrs <- rbind(hrs.cd3, hrs.cd8, hrs.rand)

rr[, tipMMR := factor(ifelse(CD8_200r > 50, ifelse(pMMR == "dMMR", "dMMR", "tipMMR"), as.character(pMMR)))]
km_plot(rr[pMMR=="pMMR" & PFSDays > 90], parm="tipMMR", parm.name="tipMMR",parm.labels=c(tipMMR="tipMMR",pMMR="pMMR"), flip=TRUE, flip.labels=TRUE, pfs=TRUE)

# plot of HR by number of samples designated as tipMMR
g <- ggplot(hrs, aes(x=numtip, y=hr, color=cell)) + geom_point() + theme_jw()
```



```{r neoadjuvant}
redcap[grepl("y",TNM_At_Diagnosis), Location]
table(grepl("y", redcap$TNM_At_Diagnosis))
```

```{r clinical-figures}

# grade
g <- ggplot(redcap, aes(x = Grade, fill = pMMR, group=pMMR)) +
  geom_bar(color="black") +
  labs(x = "Histological grade",
       y = "Count") +
  scale_fill_manual(values = pMMR_colors) +
  theme_jw() + theme(legend.position = "none")
save_pdf(g, "grade_bar.pdf", width=3, height=3)

# Gender
g <- ggplot(redcap, aes(x = Gender, fill = pMMR, group=pMMR)) +
  geom_bar(color="black") +
  labs(x = "Gender",
       y = "Count") +
  scale_fill_manual(values = pMMR_colors) +
  theme_jw() + theme(legend.position = "none")
save_pdf(g, "gender_bar.pdf", width=2, height=3)

# location
g <- ggplot(redcap, aes(x = Location, fill = pMMR, group=pMMR)) +
  geom_bar(color="black") +
  labs(x = "Anatomical location",
       y = "Count") +
  scale_fill_manual(values = pMMR_colors) +
  theme_jw() + theme(legend.position = "none")
save_pdf(g, "location_bar.pdf", width=6, height=3)

# stage
g <- ggplot(redcap, aes(x = Stage_At_Diagnosis, fill = pMMR, group=pMMR)) +
  geom_bar(color="black") +
  labs(x = "Stage at diagnosis",
       y = "Count") +
  scale_fill_manual(values = pMMR_colors) +
  theme_jw()
save_pdf(g, "stage_bar.pdf", width=3, height=3)

# age
g <- ggplot(redcap, aes(x = pMMR, y = Age, fill = pMMR)) +
  geom_boxplot(alpha = 1, width=0.8, outlier.shape=NA) + 
  geom_jitter(position = position_jitter(width = 0.2), size = 3, alpha = 1, shape=20) +  
  labs(y = "Age") +
  scale_fill_manual(values = pMMR_colors) +
  theme_jw() + theme(legend.position = "none")
save_pdf(g, "age_box.pdf", width=3, height=3)

```

```{r mutations}

# reshape the mutation data
long_data <- redcap %>%
  gather(key = "Mutation", value = "Status", APC, p53, KRAS, BRAF, PIK3CA, SOX9, FBXW7, TCF7L2, CTNNB1, PTEN, NRAS) %>%
  filter(Status == 1)  # Keep only mutated entries

# Compute the total count for each mutation
mutation_counts <- long_data %>%
  group_by(Mutation) %>%
  summarize(Total = n())
long_data$Mutation <- factor(long_data$Mutation, levels = rev(mutation_counts$Mutation[order(-mutation_counts$Total)]))

# Bar chart of mutation counts
g <- ggplot(long_data, aes(x = Mutation, fill = as.factor(pMMR))) +
  geom_bar(color="black") +  # Stacked bar chart
  coord_flip() +  # Make the bar chart horizontal
  labs(title = "Mutation Counts by pMMR Status",
       x = "Mutation",
       y = "Count") +
  theme_jw() + 
  scale_fill_manual(values = pMMR_colors, name = "MMR status")

# KM curves by mutation
g <- lapply(c("APC","p53","KRAS","BRAF","PIK3CA"), function(x) {
 km_plot(redcap, x, x, c("0"="WT", "1"="Mutated"), pfs=TRUE)
})

# Known HRs by effect
known <- data.table()
#known <- rbind(known, data.table(variable="PIK3CA", hr=1.20, lower=0.98, upper=1.46, pmid="27436848", type="PFS", note=""))
known <- rbind(known, data.table(variable="PIK3CA", hr=0.96, lower=0.83, upper=1.12, pmid="27436848", type="OS", note=""))
known <- rbind(known, data.table(variable="APC", hr=0.62, lower=0.44, upper=0.83, pmid="33230914", type="OS", note="pMMR only"))
known <- rbind(known, data.table(variable="BRAF", hr=2.25, lower=1.82, upper=2.83, pmid="34843402", type="OS", note=""))
known <- rbind(known, data.table(variable="LVI", hr=2.37, lower=0.95, upper=5.89, pmid="24886281", type="OS", note="Stage III"))
known <- rbind(known, data.table(variable="PNI", hr=0.99, lower=0.14, upper=7.14, pmid="24886281", type="OS", note="Stage III"))
known <- rbind(known, data.table(variable="Grade", hr=1.45, lower=0.72, upper=2.90, pmid="24886281", type="OS", note="Poor differentiation. Stage III"))
known <- rbind(known, data.table(variable="Gender", hr=1.16, lower=0.75, upper=1.80, pmid="24886281", type="OS", note="Male. Stage III"))
known[, source := "lit"]

# HR by mutation
hr <- rbindlist(lapply(nn <- c("APC","p53","KRAS","BRAF","PIK3CA", "LVI","PNI","Grade", "mucinous", "Gender"), function(x) {
 rr <- data.table::copy(redcap)
 flip = FALSE
 if (x == "Grade") {
   rr <- redcap[Grade != "Unknown"]
   flip=TRUE
 }
 dt <- km_plot(rr, x, x, c("0"="WT", "1"="Mutated"), pfs=TRUE, return.model=TRUE, flip=flip)
 return(data.table(hr = dt$hr, lower = dt$lower, upper = dt$upper, variable=x))
}))
hr$variable <- factor(hr$variable, levels = hr$variable[order(-hr$HR)])
hr[, source := "us"]

#plot just our hazard ratios
g <- ggplot(hr, aes(y = variable, x = hr)) +
  geom_point(aes(x = hr), size = 3) +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.2) +
  labs(x = "Hazard Ratio",
       y = "Gene") +
    geom_vline(aes(xintercept = 1), color = "red", linetype = "dashed") +  # Add vertical red line at HR = 1
  theme_jw()

# Combine our cohort with the literature
combined_data <- rbindlist(list(hr, known), fill = TRUE)
combined_data$variable <- factor(combined_data$variable, levels = hr$variable[order(-hr$hr)])
g <- ggplot(combined_data, aes(y = variable, x = hr, color = source)) +
  geom_point(aes(x = hr), size = 3, position = position_dodge(width = 0.3)) +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.2, position = position_dodge(width = 0.3)) +
  scale_color_manual(values = c("us" = "black", "lit" = "red")) +
  labs(title = "Hazard Ratios with Confidence Intervals",
       x = "Hazard Ratio",
       y = "Gene") +
  theme_jw() +
      geom_vline(aes(xintercept = 1), color = "black", linetype = "dashed") +  # Add vertical red line at HR = 1
  theme(legend.title = element_blank())
```

```{r km-curves}
g <- km_plot(redcap, "pMMR", "pMMR", c("0"="dMMR", "1"="pMMR"), pfs=FALSE, flip=TRUE) + scale_color_manual(values=pMMR_colors) + scale_fill_manual(values=pMMR_colors)
```

```{r cox-ph-no-imaging-no-molecular}
ix <- rep(TRUE, nrow(redcap))
survival_object <- Surv(redcap$PFSDays[ix], ifelse(redcap$PFSCensor[ix]==0,1,0))
cox_model <- coxph(survival_object ~ redcap$Gender[ix] + redcap$mucinous[ix] + redcap$Grade[ix] + redcap$LVI[ix] + redcap$PNI[ix] + redcap$stage_num[ix] + redcap$pMMR[ix])

# Extract the coefficients from the Cox model
coefficients <- cox_model$coefficients
hr <- exp(coefficients)
hr <- data.table(
  variable = names(coefficients),
  HR = hr,
  lower = exp(as.data.table(confint(cox_model, level = 0.95))$`2.5 %`),
  upper = exp(as.data.table(confint(cox_model, level = 0.95))$`97.5 %`)
)
hr$variable <- factor(hr$variable, levels = hr$variable[order(-hr$HR)])

# Create the forest plot
g <- ggplot(
  data = hr,
  aes(x = variable, y = HR, ymin = lower, ymax = upper)) +
  geom_pointrange(size = 0.8) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  xlab("Covariate") +
  ylab("Hazard Ratio") +
  theme_jw()
```

```{r cox-ph-no-imaging-with-molecular}
ix <- rep(TRUE, nrow(redcap))
ix <- redcap[, pMMR=="pMMR"]
survival_object <- Surv(redcap$PFSDays[ix], ifelse(redcap$PFSCensor[ix]==0,1,0))
cox_model <- coxph(survival_object ~ redcap$Gender[ix] + redcap$mucinous[ix] + redcap$Grade[ix] + redcap$LVI[ix] + redcap$PNI[ix] + redcap$stage_num[ix] + redcap$pMMR[ix] + redcap$APC[ix] + redcap$KRAS[ix] + redcap$p53[ix] +
                     redcap$BRAF[ix] + redcap$PIK3CA[ix] + redcap$tmb[ix])

# Extract the coefficients from the Cox model
coefficients <- cox_model$coefficients
hr <- exp(coefficients)
hr <- data.table(
  variable = names(coefficients),
  HR = hr,
  lower = exp(as.data.table(confint(cox_model, level = 0.95))$`2.5 %`),
  upper = exp(as.data.table(confint(cox_model, level = 0.95))$`97.5 %`)
)
hr$variable <- factor(hr$variable, levels = hr$variable[order(-hr$HR)])

# Create the forest plot
g <- ggplot(
  data = hr,
  aes(x = variable, y = HR, ymin = lower, ymax = upper)) +
  geom_pointrange(size = 0.8) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip(ylim=c(0,10)) +
  xlab("Covariate") +
  ylab("Hazard Ratio") +
  theme_jw()
```

```{r cd3-by-tissue}
# Reshape data to long format
rr_long <- melt(rr, id.vars = "pMMR", measure.vars = c("CD3_200r", "CD4_200r","CD8_200r"), variable.name = "Metric", value.name = "Value")
rr_long[, cells_per_mm2 := Value * 1e6 / (1000^2 * 0.325^2)]
t.test(rr[pMMR=="pMMR", CD3_200r], rr[pMMR=="dMMR", CD3_200r]) # p = 0.02745
t.test(rr[pMMR=="pMMR", CD4_200r], rr[pMMR=="dMMR", CD4_200r]) # p = 0.4261
t.test(rr[pMMR=="pMMR", CD8_200r], rr[pMMR=="dMMR", CD8_200r]) # p = 0.01863
wilcox.test(rr[pMMR=="pMMR", CD3_200r], rr[pMMR=="dMMR", CD3_200r]) # p = 0.004448
wilcox.test(rr[pMMR=="pMMR", CD4_200r], rr[pMMR=="dMMR", CD4_200r]) # p = 0.4273
wilcox.test(rr[pMMR=="pMMR", CD8_200r], rr[pMMR=="dMMR", CD8_200r]) # p = 0.001122
rr_long[, cells_per_mm2 := Value * 1e6 / (1000^2 * 0.325^2)]

# Plot T cells subsets
g <- ggplot(rr_long, aes(x = pMMR, y = cells_per_mm2, fill = pMMR)) +
  geom_boxplot(alpha = 0.5, width=0.8, outlier.shape=NA) +
  geom_jitter(position = position_jitter(width = 0.2), size = 1, alpha = 0.7, shape=20) +
  labs(y = "Cells / mm2") +
  coord_cartesian(ylim=c(0,40000)) +
  scale_fill_manual(values = pMMR_colors) +
  facet_wrap(~ Metric) +  # Separate panel for each y variable
  theme_jw()

# Plot B and PD1 subsets
rr_long <- melt(rr, id.vars = "pMMR", measure.vars = c("CD20_200r", "PD1_200r","PD_L1_200r"), variable.name = "Metric", value.name = "Value")
wilcox.test(rr[pMMR=="pMMR", CD20_200r], rr[pMMR=="dMMR", CD20_200r]) # p = 0.06399
wilcox.test(rr[pMMR=="pMMR", PD1_200r], rr[pMMR=="dMMR", PD1_200r]) # p = 0.09163
wilcox.test(rr[pMMR=="pMMR",PD_L1_200r], rr[pMMR=="dMMR", PD_L1_200r]) # p = 0.02668
rr_long[, cells_per_mm2 := Value * 1e6 / (1000^2 * 0.325^2)]
g <- ggplot(rr_long, aes(x = pMMR, y = cells_per_mm2, fill = pMMR)) +
  geom_boxplot(alpha = 0.5, width=0.8, outlier.shape=NA) +
  geom_jitter(position = position_jitter(width = 0.2), size = 1, alpha = 0.7, shape=20) +
  labs(y = "Cells / mm2") +
  coord_cartesian(ylim=c(0,20000)) + 
  scale_fill_manual(values = pMMR_colors) +
  facet_wrap(~ Metric) +  # Separate panel for each y variable
  theme_jw()

# Plot innate cells subsets
rr_long <- melt(rr, id.vars = "pMMR", measure.vars = c("CD31_200r", "CD68_200r","CD163_200r"), variable.name = "Metric", value.name = "Value")
wilcox.test(rr[pMMR=="pMMR", CD31_200r], rr[pMMR=="dMMR", CD31_200r]) # p = 0.921
wilcox.test(rr[pMMR=="pMMR", CD68_200r], rr[pMMR=="dMMR", CD68_200r]) # p = 0.2608
wilcox.test(rr[pMMR=="pMMR", CD163_200r], rr[pMMR=="dMMR", CD163_200r]) # p = 0.2678
rr_long[, cells_per_mm2 := Value * 1e6 / (1000^2 * 0.325^2)]
g <- ggplot(rr_long, aes(x = pMMR, y = cells_per_mm2, fill = pMMR)) +
  geom_boxplot(alpha = 0.5, width=0.8, outlier.shape=NA) +
  geom_jitter(position = position_jitter(width = 0.2), size = 1, alpha = 0.7, shape=20) +
  labs(y = "Cells / mm2") +
  scale_fill_manual(values = pMMR_colors) +
  facet_wrap(~ Metric) +  # Separate panel for each y variable
  theme_jw()
```

```{r CD8_200r-distribution}
## CD8
setkey(rr, CD8_200r)
cd8_levels <- rr$Slide_ID
rr[, Slide_ID := factor(Slide_ID, levels=cd8_levels)]
g <- ggplot(rr, aes(x=Slide_ID, y=CD8_200r, fill=pMMR)) + 
  geom_bar(stat="identity")+
  coord_flip() +
  scale_fill_manual(values=pMMR_colors) +
  theme_jw()


## CD3
setkey(rr, CD3_200r)
cd3_levels <- rr$Slide_ID
rr[, Slide_ID := factor(Slide_ID, levels=cd3_levels)]
g <- ggplot(rr, aes(x=Slide_ID, y=CD3_200r, fill=pMMR)) + 
  geom_bar(stat="identity")+
  coord_flip() +
  scale_fill_manual(values=pMMR_colors) +
  theme_jw()
```

```{r TIL-vs-CD3}
rr[, cells_per_mm2 := CD45_200r * 1e6 / (1000^2 * 0.325^2)]
rr[, TIL := factor(TIL, levels=c("absent","mild","moderate","marked"))]
g <- ggplot(rr[!is.na(TIL)], aes(x = TIL, y = cells_per_mm2)) +
  geom_boxplot(alpha = 0.5, width=0.8, outlier.shape=NA) +
  ylab("CD45+ cells/mm2") +
  geom_jitter(position = position_jitter(width = 0.2), size = 1, alpha = 0.7, shape=20) +
  theme_jw()
wilcox.test(rr[TIL=="absent", CD45_200r], rr[TIL=="marked", CD45_200r])
wilcox.test(rr[TIL=="absent", CD45_200r], rr[TIL=="marked", CD45_200r])
```

```{r gene-mutation-enrichment-tipmmr}
## bar chart on pMMR, tipMMR, dMMR on Mutations
rrm <- melt(rr, id.vars = "tipMMR", measure.vars = c("BRAF", "APC", "CTNNB1", "KRAS", "p53","PIK3CA"), variable.name="Gene")
result <- rrm[, .(n = .N, mut = sum(value == 1, na.rm=TRUE)), by = .(tipMMR, Gene)]
result[, SE := sqrt((mut/n) * (1 - mut/n) / n)]
result[, lower_limit := mut/n - 1.96*SE]
result$lower_limit[result$lower_limit < 0] <- 0

fisher.test(matrix(c(sum(rr[tipMMR=="tipMMR", .(BRAF)]), rr[tipMMR=="tipMMR",.N],
  sum(rr[tipMMR=="pMMR", .(BRAF)], na.rm=TRUE), rr[tipMMR=="pMMR", .N]), nrow=2, ncol=2))
fisher.test(matrix(c(sum(rr[tipMMR=="tipMMR", .(APC)]), rr[tipMMR=="tipMMR",.N],
  sum(rr[tipMMR=="pMMR", .(APC)], na.rm=TRUE), rr[tipMMR=="pMMR", .N]), nrow=2, ncol=2))
fisher.test(matrix(c(sum(rr[tipMMR=="tipMMR", .(CTNNB1)]), rr[tipMMR=="tipMMR",.N],
  sum(rr[tipMMR=="pMMR", .(CTNNB1)], na.rm=TRUE), rr[tipMMR=="pMMR", .N]), nrow=2, ncol=2))

g <- ggplot(result, aes(x=Gene, fill=tipMMR, y=mut/n)) + 
  geom_bar(stat="identity", position="dodge", color="black") + 
  theme_jw() + scale_fill_manual(values=pMMR_colors) +
  ylab("Fraction of samples with mutation") +
  geom_errorbar(aes(ymin=lower_limit, ymax=mut/n + 1.96*SE), width=0.25, position=position_dodge(0.9))
save_pdf(g, "tipMMR_gene_bars.pdf", width=4.5,height=2)

## bar chart on pMMR, tipMMR, dMMR on Grade, Mucionus, LVI, PNI etc
rrm <- melt(rr, id.vars = "tipMMR", measure.vars = c("mucinous", "Grade", "LVI","PNI"), variable.name="Variable")
rrm[Variable=="Grade", value := as.integer(value=="High")]
result <- rrm[!is.na(value), .(n = .N, mut = sum(value == 1, na.rm=TRUE)), by = .(tipMMR, Variable)]
result[, SE := sqrt((mut/n) * (1 - mut/n) / n)]
result[, lower_limit := mut/n - 1.96*SE]
result$lower_limit[result$lower_limit < 0] <- 0

g <- ggplot(result, aes(x=Variable, fill=tipMMR, y=mut/n)) + 
  geom_bar(stat="identity", position="dodge", color="black") + 
  theme_jw() + scale_fill_manual(values=pMMR_colors) +
  ylab("Fraction of samples with feature") +
  geom_errorbar(aes(ymin=lower_limit, ymax=mut/n + 1.96*SE), width=0.25, position=position_dodge(0.9))
save_pdf(g, "tipMMR_hist_bars.pdf", width=3,height=2)

# age
g <- ggplot(rr, aes(x = tipMMR, y = Age, fill = tipMMR)) +
  geom_boxplot(alpha = 1, width=0.8, outlier.shape=NA) +  # Boxplot in the background with some transparency
  geom_jitter(position = position_jitter(width = 0.2), size = 1, alpha = 1, shape=20) +  # Scatter plot with jitter
  labs(y = "Age") +
  scale_fill_manual(values = pMMR_colors) +
  theme_jw() + theme(legend.position = "none")
save_pdf(g, "tipMMR_age_box.pdf", width=3,height=2)

t.test(rr[tipMMR=="tipMMR", Age], rr[tipMMR=="dMMR", Age])
t.test(rr[tipMMR=="dMMR", Age], rr[tipMMR=="pMMR", Age])

# location
rrm <- melt(rr, id.vars = "tipMMR", measure.vars = c("side"), variable.name="side")
result <- rr[, .(SideCount = .N), by = .(tipMMR, side)][, N := sum(SideCount), by = tipMMR]
result <- rbind(result, data.table(tipMMR="dMMR",side="Rectal",SideCount=0, N=9))

result[, SE := sqrt((SideCount/N) * (1 - SideCount/N) / N)]
result[, lower_limit := SideCount/N - 1.96*SE]
result$lower_limit[result$lower_limit < 0] <- 0

g <- ggplot(result, aes(x=side, fill=tipMMR, y=SideCount/N)) + 
  geom_bar(stat="identity", position="dodge", color="black") + 
  theme_jw() + scale_fill_manual(values=pMMR_colors) +
  ylab("Fraction of samples with feature") +
  geom_errorbar(aes(ymin=lower_limit, ymax=SideCount/N + 1.96*SE), width=0.25, position=position_dodge(0.9))
save_pdf(g, "tipMMR_side_bars.pdf", width=3,height=2)

# gender bar chart on pMMR, tipMMR, dMMR on Mutations
# Calculating number of males and females, and the male-to-female ratio
result <- rrm[, .(n = .N, mut = sum(value == "M", na.rm=TRUE), females = sum(value != "M", na.rm=TRUE)), by = .(tipMMR)]
result[, ratio := mut/females]
result[, deviation := ratio - 1]

# Plotting the deviation from a ratio of 1 using horizontal bars
g <- ggplot(result, aes(y=tipMMR, x=deviation, fill=tipMMR)) + 
  geom_bar(stat="identity", position="dodge", color="black") + 
  scale_fill_manual(values=pMMR_colors) +
  #xlab("Deviation from Male-to-Female Ratio of 1 (Right indicates male predominance)") +
  geom_vline(xintercept=0, linetype="dashed") +  # Add a vertical dashed line at 0 for reference
  theme_jw() + 
  scale_x_continuous(name="M:F ratio", breaks=seq(-0.5, 0.5, by=0.25), labels=seq(0.5, 1.5, by=0.25))
save_pdf(g,"tipMMR_gender_bars.pdf", width=3, height=1)
```

```{r cd3-stage}
rr_long <- melt(rr, id.vars = c("tipMMR","stage_num"), measure.vars = c("CD3_200r"), variable.name = "Metric", value.name = "Value")
g <- ggplot(rr_long, aes(x=as.factor(stage_num), y = Value* 1e6 / (1000^2 * 0.325^2))) +
  geom_boxplot(alpha = 0.5, width=0.8, outlier.shape=NA,notch=FALSE) +
  geom_jitter(position = position_jitter(width = 0.2), size = 1, shape=16) +
  labs(y = "Cells / mm2") +
  scale_y_log10()+
  scale_x_discrete(labels =c("I","II","III","IV")) +
  scale_fill_manual(values = pMMR_colors) +
  theme_jw() + theme(axis.title.x = element_blank())
save_pdf(g, "stage_CD3_boxplot.pdf", width=3,height=3)
```

```{r checkpoint}
## PD1
setkey(rr, PD1_200r)
pd1_levels <- rr$Slide_ID
rr[, Slide_ID := factor(Slide_ID, levels=pd1_levels)]
g <- ggplot(rr, aes(x=Slide_ID, y=PD1_200r, fill=tipMMR)) + 
  geom_bar(stat="identity")+
  coord_flip() +
  scale_fill_manual(values=pMMR_colors) +
  theme_jw() + scale_y_log10()
save_pdf(g, "pd1_waterfall.pdf", width=6, height=6)

# PD-L1
setkey(rr, PD_L1_200r)
pdl1_levels <- rr$Slide_ID
rr[, Slide_ID := factor(Slide_ID, levels=pdl1_levels)]
g <- ggplot(rr, aes(x=Slide_ID, y=PD_L1_200r, fill=tipMMR)) + 
  geom_bar(stat="identity")+
  coord_flip() +
  scale_fill_manual(values=pMMR_colors) +
  theme_jw() + scale_y_log10()
save_pdf(g, "pdl1_waterfall.pdf", width=6, height=6)

# CD45RO
setkey(rr, CD45RO_200r)
plevels <- rr$Slide_ID
rr[, Slide_ID := factor(Slide_ID, levels=plevels)]
g <- ggplot(rr, aes(x=Slide_ID, y=CD45RO_200r, fill=tipMMR)) + 
  geom_bar(stat="identity")+
  coord_flip() +
  scale_fill_manual(values=pMMR_colors) +
  theme_jw() + scale_y_log10()
p = ttest_pairs(rr, "tipMMR","CD45RO_200r")
#save_pdf(g, "pdl1_waterfall.pdf", width=6, height=6)

# Pan-CK -- PD-L1
setkey(rr, PanCKpPDL1_200r)
plevels <- rr$Slide_ID
rr[, Slide_ID := factor(Slide_ID, levels=plevels)]
g <- ggplot(rr, aes(x=Slide_ID, y=PanCKpPDL1_200r, fill=tipMMR)) + 
  geom_bar(stat="identity")+
  coord_flip() +
  scale_fill_manual(values=pMMR_colors) +
  theme_jw() + scale_y_log10()
save_pdf(g, "PanCKpPDL1_200r_waterfall.pdf", width=6, height=6)

# double-positive PD-L1 ratios
rr[, pdl1_div_cd168_200r := PD_L1_200r/CD163_200r]
rr[, pdl1_div_panCK_200r := PD_L1_200r/PanCK_200r]
rr_long <- melt(rr, id.vars = "tipMMR", measure.vars = c("pdl1_div_cd168_200r", "pdl1_div_panCK_200r"), variable.name = "Metric", value.name = "Value")
rr_long[, cells_per_mm2 := Value * 1e6 / (1000^2 * 0.325^2)]
g <- ggplot(rr_long, aes(x = tipMMR, y = cells_per_mm2, fill = tipMMR)) +
  geom_boxplot(alpha = 0.5, width=0.8, outlier.shape=NA) +
  geom_jitter(position = position_jitter(width = 0.2), size = 1, alpha = 0.7, shape=20) +
  labs(y = "Cells / mm2") +
  scale_fill_manual(values = pMMR_colors) +
  facet_wrap(~ Metric) +
  theme_jw()

rr_long <- melt(rr, id.vars = "tipMMR", measure.vars = c("PD1_200r", "PD_L1_200r", "CD45RO_200r"), variable.name = "Metric", value.name = "Value")
rr_long[, cells_per_mm2 := Value * 1e6 / (1000^2 * 0.325^2)]
pd1 = ttest_pairs(rr, "tipMMR","PD1_200r")
pdl1 = ttest_pairs(rr, "tipMMR","PD_L1_200r")

# Plot PD1/PDL1 
g <- ggplot(rr_long, aes(x = tipMMR, y = cells_per_mm2, fill = tipMMR)) +
  geom_boxplot(alpha = 0.5, width=0.8, outlier.shape=NA) +
  geom_jitter(position = position_jitter(width = 0.2), size = 1, alpha = 0.7, shape=20) +
  labs(y = "Cells / mm2") +
  scale_y_log10()+
  scale_fill_manual(values = pMMR_colors) +
  facet_wrap(~ Metric) +
  theme_jw()
save_pdf(g, "pd1_pdl1_cd45ro_boxplot_tip.pdf", width=6,height=3)
```

```{r dbscan}
f <- data.table::fread(cmd="cysift view ~/Sorger/projects/orion/orion_1_74/chain/LSP10353.dbscan.cys")
fplot <- f[sample(.N,1e5), .(V5, V6,V217)][, cluster := ifelse(V217 > 0, "tumor","stroma")]
g <- ggplot(fplot, aes(x=V5, y=V6, color=cluster)) + geom_point(size=0.1, shape=20) + theme_jw() + scale_color_manual(values=c(tumor="blue",stroma="red"))
save_pdf(g, "dbtest.pdf", width=15, height=15)
```

```{r margins}
dtr <- rbindlist(lapply(c("~/Sorger/cache/margin5.rds",
                         "~/Sorger/cache/margin4.rds",
                         "~/Sorger/cache/core1.rds"), readRDS))
rr <- merge(data.table::copy(redcap), dtr, by = "Slide_ID", all.x = TRUE)

rr_long <- melt(rr, id.vars = c("tipMMR","margin"), measure.vars = c(#"PD1_200r", "PD_L1_200r", "CD45RO_200r",
                                                                     "CD3_20g","CD4_20g","CD8_20g"),
                                                                     #"SMA_200r"), 
                variable.name = "Metric", value.name = "Value")
rr_long[, Metric_margin := interaction(Metric, margin, sep = " - ")]
rr_long[, cells_per_mm2 := Value * 1e6 / (1000^2 * 0.325^2)]

g <- ggplot(rr_long[margin != "margin5"], aes(x = tipMMR, y = cells_per_mm2, fill = margin)) +
  geom_boxplot(alpha = 0.4, width=0.8, outlier.shape=NA) +
  #geom_jitter(aes(color=margin), size = 1, alpha = 0.7, shape=20) +
  labs(y = "Cells / mm2") +
  scale_y_log10() + 
  #scale_fill_manual(values = pMMR_colors) +
  facet_wrap(~ Metric) + theme_jw()
save_pdf(g, "margin_compare_tcell_boxplot.pdf", width=6, height=3)
```



